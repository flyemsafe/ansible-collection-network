---
# Traefik Static Configuration
# Generated by Ansible - DO NOT EDIT MANUALLY
# Role: rhdc.network.traefik
# Host: {{ traefik_host }}
# Date: {{ ansible_date_time.iso8601 }}

global:
  checkNewVersion: false
  sendAnonymousUsage: false

# Entry Points
entryPoints:
  web:
    address: ":{{ traefik_http_port }}"
{% if traefik_https_port is defined %}
    http:
      redirections:
        entryPoint:
          to: websecure
          scheme: https
          permanent: true
{% endif %}

{% if traefik_https_port is defined %}
  websecure:
    address: ":{{ traefik_https_port }}"
    http:
      tls:
        certResolver: {{ traefik_acme_dns_provider if traefik_acme_enabled else 'default' }}
{% if traefik_tls_min_version is defined %}
        options: default
{% endif %}
{% endif %}

{% if traefik_dashboard_enabled %}
  traefik:
    address: ":{{ traefik_dashboard_port }}"
{% endif %}

{% if traefik_metrics_prometheus_enabled %}
  metrics:
    address: ":{{ traefik_metrics_prometheus_port }}"
{% endif %}

# API and Dashboard
api:
  dashboard: {{ traefik_dashboard_enabled | lower }}
{% if traefik_dashboard_insecure %}
  insecure: true
{% else %}
  insecure: false
{% endif %}

# Ping healthcheck
ping:
  entryPoint: "traefik"

# Providers
providers:
  # File Provider - watches dynamic configuration files
  file:
    directory: /config/dynamic
    watch: true

# Certificate Resolvers (ACME / Let's Encrypt)
{% if traefik_acme_enabled %}
certificatesResolvers:
  {{ traefik_acme_dns_provider }}:
    acme:
      email: {{ traefik_acme_email }}
      storage: /config/acme.json
      caServer: {{ traefik_acme_ca_server }}
{% if traefik_acme_challenge_type == 'dns-01' %}
      dnsChallenge:
        provider: {{ traefik_acme_dns_provider }}
{% if traefik_cloudflare_dns_resolvers is defined and traefik_cloudflare_dns_resolvers | length > 0 %}
        resolvers:
{% for resolver in traefik_cloudflare_dns_resolvers %}
          - {{ resolver }}
{% endfor %}
{% endif %}
{% elif traefik_acme_challenge_type == 'http-01' %}
      httpChallenge:
        entryPoint: web
{% elif traefik_acme_challenge_type == 'tls-alpn-01' %}
      tlsChallenge: {}
{% endif %}
{% endif %}

# Logging
log:
  level: {{ traefik_log_level }}
{% if traefik_log_file is defined %}
  filePath: {{ traefik_log_file }}
{% endif %}
  format: json

{% if traefik_access_log_enabled %}
accessLog:
  format: {{ traefik_access_log_format }}
  filePath: {{ traefik_access_log_file }}
  filters:
    statusCodes:
      - "200-299"
      - "300-399"
      - "400-499"
      - "500-599"
{% endif %}

# Metrics
{% if traefik_metrics_enabled %}
metrics:
{% if traefik_metrics_prometheus_enabled %}
  prometheus:
    entryPoint: metrics
    addEntryPointsLabels: true
    addRoutersLabels: true
    addServicesLabels: true
{% endif %}
{% endif %}

# TLS Options
{% if traefik_tls_min_version is defined %}
tls:
  options:
    default:
      minVersion: {{ traefik_tls_min_version }}
{% if traefik_tls_cipher_suites is defined and traefik_tls_cipher_suites | length > 0 %}
      cipherSuites:
{% for cipher in traefik_tls_cipher_suites %}
        - {{ cipher }}
{% endfor %}
{% endif %}
{% endif %}

# Server Transports (for insecure backends)
serversTransports:
  insecureTransport:
    insecureSkipVerify: true
