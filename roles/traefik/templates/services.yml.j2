---
# Traefik Dynamic Services Configuration
# Generated by Ansible - DO NOT EDIT MANUALLY
# Role: rhdc.network.traefik
# Host: {{ traefik_host }}
# Date: {{ ansible_date_time.iso8601 }}

http:
  # Routers
  routers:
{% for service in traefik_services %}
    {{ service.name }}:
      rule: "Host(`{{ service.hostname }}`)"
      service: {{ service.name }}-backend
      entryPoints:
        - websecure
{% if traefik_acme_enabled %}
      tls:
        certResolver: {{ traefik_acme_dns_provider }}
{% endif %}
{% if service.middlewares is defined and service.middlewares | length > 0 %}
      middlewares:
{% for middleware in service.middlewares %}
        - {{ middleware }}
{% endfor %}
{% endif %}
{% if service.priority is defined %}
      priority: {{ service.priority }}
{% endif %}

{% endfor %}

  # Services (Backends)
  services:
{% for service in traefik_services %}
    {{ service.name }}-backend:
      loadBalancer:
        servers:
          - url: "{{ service.backend_url }}"
{% if service.insecure_skip_verify is defined and service.insecure_skip_verify %}
        serversTransport: insecureTransport
{% endif %}
{% if service.health_check_path is defined %}
        healthCheck:
          path: {{ service.health_check_path }}
          interval: {{ service.health_check_interval | default('10s') }}
          timeout: {{ service.health_check_timeout | default('3s') }}
{% endif %}
{% if service.sticky_sessions is defined and service.sticky_sessions %}
        sticky:
          cookie:
            name: {{ service.sticky_cookie_name | default(service.name + '_sticky') }}
            secure: true
            httpOnly: true
{% endif %}

{% endfor %}

  # Server Transports
  serversTransports:
    insecureTransport:
      insecureSkipVerify: true

{% if traefik_dashboard_enabled and traefik_dashboard_auth_enabled and traefik_dashboard_users | length > 0 %}
---
# Dashboard Router (if authentication enabled)
http:
  routers:
    dashboard:
      rule: "Host(`{{ traefik_host }}`) && (PathPrefix(`/api`) || PathPrefix(`/dashboard`))"
      service: api@internal
      entryPoints:
        - traefik
{% if traefik_acme_enabled %}
      tls:
        certResolver: {{ traefik_acme_dns_provider }}
{% endif %}
      middlewares:
        - dashboard-auth

  middlewares:
    dashboard-auth:
      basicAuth:
        users:
{% for user in traefik_dashboard_users %}
          - "{{ user }}"
{% endfor %}
{% endif %}
