---
# Traefik Dynamic Middlewares Configuration
# Generated by Ansible - DO NOT EDIT MANUALLY
# Role: rhdc.network.traefik
# Host: {{ traefik_host }}
# Date: {{ ansible_date_time.iso8601 }}

http:
  middlewares:
{% for middleware in traefik_middlewares %}
    {{ middleware.name }}:
{% if middleware.type == 'headers' %}
      headers:
{% if middleware.config.customRequestHeaders is defined %}
        customRequestHeaders:
{% for header, value in middleware.config.customRequestHeaders.items() %}
          {{ header }}: "{{ value }}"
{% endfor %}
{% endif %}
{% if middleware.config.customResponseHeaders is defined %}
        customResponseHeaders:
{% for header, value in middleware.config.customResponseHeaders.items() %}
          {{ header }}: "{{ value }}"
{% endfor %}
{% endif %}
{% if middleware.config.sslRedirect is defined %}
        sslRedirect: {{ middleware.config.sslRedirect | lower }}
{% endif %}
{% if middleware.config.stsSeconds is defined %}
        stsSeconds: {{ middleware.config.stsSeconds }}
{% endif %}
{% if middleware.config.stsIncludeSubdomains is defined %}
        stsIncludeSubdomains: {{ middleware.config.stsIncludeSubdomains | lower }}
{% endif %}
{% if middleware.config.stsPreload is defined %}
        stsPreload: {{ middleware.config.stsPreload | lower }}
{% endif %}

{% elif middleware.type == 'ratelimit' %}
      rateLimit:
        average: {{ middleware.config.average | default(100) }}
        burst: {{ middleware.config.burst | default(50) }}
{% if middleware.config.period is defined %}
        period: {{ middleware.config.period }}
{% endif %}

{% elif middleware.type == 'basicauth' %}
      basicAuth:
        users:
{% for user in middleware.config.users %}
          - "{{ user }}"
{% endfor %}
{% if middleware.config.realm is defined %}
        realm: "{{ middleware.config.realm }}"
{% endif %}

{% elif middleware.type == 'compress' %}
      compress:
{% if middleware.config.excludedContentTypes is defined %}
        excludedContentTypes:
{% for content_type in middleware.config.excludedContentTypes %}
          - {{ content_type }}
{% endfor %}
{% endif %}

{% elif middleware.type == 'redirectscheme' %}
      redirectScheme:
        scheme: {{ middleware.config.scheme | default('https') }}
        permanent: {{ middleware.config.permanent | default(true) | lower }}

{% elif middleware.type == 'stripprefix' %}
      stripPrefix:
        prefixes:
{% for prefix in middleware.config.prefixes %}
          - {{ prefix }}
{% endfor %}

{% elif middleware.type == 'addprefix' %}
      addPrefix:
        prefix: {{ middleware.config.prefix }}

{% elif middleware.type == 'replacepath' %}
      replacePath:
        path: {{ middleware.config.path }}

{% elif middleware.type == 'circuitbreaker' %}
      circuitBreaker:
        expression: "{{ middleware.config.expression }}"

{% elif middleware.type == 'retry' %}
      retry:
        attempts: {{ middleware.config.attempts | default(3) }}

{% elif middleware.type == 'forwardauth' %}
      forwardAuth:
        address: {{ middleware.config.address }}
{% if middleware.config.trustForwardHeader is defined %}
        trustForwardHeader: {{ middleware.config.trustForwardHeader | lower }}
{% endif %}
{% if middleware.config.authResponseHeaders is defined %}
        authResponseHeaders:
{% for header in middleware.config.authResponseHeaders %}
          - {{ header }}
{% endfor %}
{% endif %}

{% elif middleware.type == 'ipwhitelist' %}
      ipWhiteList:
        sourceRange:
{% for ip in middleware.config.sourceRange %}
          - {{ ip }}
{% endfor %}

{% endif %}

{% endfor %}
