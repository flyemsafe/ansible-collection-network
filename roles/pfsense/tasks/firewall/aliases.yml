---
# Configure Firewall Alias
#
# This task creates or updates a firewall alias on pfSense.
# Aliases are used to group IPs, networks, or ports for use in firewall rules.
#
# Variables required (from alias loop variable):
#   - name:      Alias name (e.g., "INTERNAL_NETWORKS")
#   - type:      Alias type: "host", "network", "port"
#   - addresses: List of addresses/ports
#   - descr:     Description (optional)

- name: Display alias configuration plan
  ansible.builtin.debug:
    msg:
      - "Configuring alias: {{ alias.name }}"
      - "Type: {{ alias.type }}"
      - "Addresses: {{ alias.addresses | join(', ') }}"
  when: ansible_verbosity >= 1

# Set default values as facts to simplify templates
- name: Set alias configuration variables
  ansible.builtin.set_fact:
    _alias_descr: "{{ alias.descr | default('Configured via Ansible') }}"
    _alias_detail: "{{ alias.detail | default('Managed by Ansible') }}"
    _alias_addresses: "{{ alias.addresses | join(' ') }}"

# Template the shell script to local temp file
- name: Template shell script for alias configuration
  ansible.builtin.template:
    src: configure_alias.sh.j2
    dest: "/tmp/configure_alias_{{ alias.name }}.sh"
    mode: '0755'
  delegate_to: localhost

# PHP shell method (primary method - API doesn't support aliases yet)
- name: Configure alias via PHP shell
  ansible.builtin.script: "/tmp/configure_alias_{{ alias.name }}.sh"
  register: _alias_php_result
  changed_when: "'SUCCESS' in _alias_php_result.stdout"

# Clean up temp file
- name: Remove temporary shell script
  ansible.builtin.file:
    path: "/tmp/configure_alias_{{ alias.name }}.sh"
    state: absent
  delegate_to: localhost

- name: Display alias configuration result
  ansible.builtin.debug:
    msg:
      - "Alias configuration: {{ 'SUCCESS' if 'SUCCESS' in _alias_php_result.stdout else 'FAILED' }}"
      - "Alias: {{ alias.name }}"
      - "Type: {{ alias.type }}"
      - "Action: {{ 'UPDATED' if 'UPDATED' in _alias_php_result.stdout else 'ADDED' if 'ADDED' in _alias_php_result.stdout else 'CONFIGURED' }}"
  when: ansible_verbosity >= 0
