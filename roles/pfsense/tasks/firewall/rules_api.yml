---
# Configure Firewall Rule via REST API
#
# This task creates or updates a firewall rule using the pfSense REST API.
# Rules control traffic between interfaces and networks.
#
# Variables required (from rule loop variable):
#   - name:        Rule description (used for idempotency)
#   - interface:   Interface name (e.g., "lan", "wan", "opt1")
#   - action:      Rule action: "pass", "block", "reject"
#
# Variables optional:
#   - protocol:    Protocol: "tcp", "udp", "icmp", "any" (default: "any")
#   - source:      Source address/network/alias (default: "any")
#   - destination: Destination address/network/alias (default: "any")
#   - destination_port: Destination port or range (optional)
#   - source_port: Source port or range (optional)
#   - disabled:    true/false (default: false)

- name: Display rule configuration plan
  ansible.builtin.debug:
    msg:
      - "Configuring firewall rule via API: {{ rule.name }}"
      - "Interface: {{ rule.interface }}"
      - "Action: {{ rule.action }}"
      - "Protocol: {{ rule.protocol | default('any') }}"
      - "Source: {{ rule.source | default('any') }} {% if rule.source_port is defined %}:{{ rule.source_port }}{% endif %}"
      - "Destination: {{ rule.destination | default('any') }} {% if rule.destination_port is defined %}:{{ rule.destination_port }}{% endif %}"
  when: ansible_verbosity >= 1

# Prepare source and destination as simple strings (API v2 requirement)
- name: Prepare source configuration
  ansible.builtin.set_fact:
    _rule_source: "{{ rule.source | default('any') }}"
    _rule_destination: "{{ rule.destination | default('any') }}"

# Check if rule already exists by description
- name: Check if rule exists
  ansible.builtin.uri:
    url: "{{ pfsense_api_url }}/firewall/rule?descr={{ rule.name | urlencode }}"
    method: GET
    validate_certs: "{{ pfsense_validate_certs }}"
    headers:
      X-API-Key: "{{ pfsense_api_key }}"
    status_code: [200, 404]
  register: _rule_check
  failed_when: false

- name: Create or update firewall rule via API
  ansible.builtin.uri:
    url: "{{ pfsense_api_url }}/firewall/rule"
    method: "{{ 'PATCH' if _rule_check.status == 200 else 'POST' }}"
    validate_certs: "{{ pfsense_validate_certs }}"
    headers:
      X-API-Key: "{{ pfsense_api_key }}"
    body_format: json
    body:
      type: "{{ rule.action }}"
      interface: "{{ [rule.interface] if rule.interface is string else rule.interface }}"
      ipprotocol: "inet"
      protocol: "{{ rule.protocol | default('any') }}"
      descr: "{{ rule.name }}"
      source: "{{ _rule_source }}"
      destination: "{{ _rule_destination }}"
      disabled: "{{ rule.disabled | default(false) }}"
    status_code: [200, 201]
  register: _rule_result

- name: Display rule configuration result
  ansible.builtin.debug:
    msg:
      - "Firewall rule configuration: SUCCESS"
      - "Rule: {{ rule.name }}"
      - "Interface: {{ rule.interface }}"
      - "Action: {{ 'UPDATED' if _rule_check.status == 200 else 'CREATED' }}"
      - "ID: {{ _rule_result.json.data.id | default('N/A') }}"
  when: ansible_verbosity >= 0
