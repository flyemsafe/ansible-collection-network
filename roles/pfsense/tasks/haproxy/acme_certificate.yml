---
# Configure Individual ACME Certificate
#
# This task handles creation and issuance of a single ACME certificate.
# Called from acme.yml in a loop for each certificate.
#
# Variables required (from certificate loop variable):
#   - name:        Certificate name (used for idempotency)
#   - domains:     List of domain configurations
#     - domain:    Domain name (can be wildcard like *.example.com)
#     - method:    Challenge method: "http01" or "dns01"
#
# Variables optional:
#   - renewafter:  Days before expiry to auto-renew (default: 60)

- name: Display certificate configuration plan
  ansible.builtin.debug:
    msg:
      - "Configuring ACME certificate: {{ certificate.name }}"
      - "Domains: {{ certificate.domains | map(attribute='domain') | list | join(', ') }}"
      - "Challenge method: {{ certificate.domains[0].method }}"
  when: ansible_verbosity >= 1

# Check if certificate already exists
- name: Check if certificate exists
  ansible.builtin.uri:
    url: "{{ pfsense_api_url }}/services/acme/certificate?name={{ certificate.name | urlencode }}"
    method: GET
    validate_certs: "{{ pfsense_validate_certs }}"
    headers:
      X-API-Key: "{{ pfsense_api_key }}"
    status_code: [200, 404]
  register: _cert_check
  failed_when: false

# Create or update certificate configuration
- name: Create or update ACME certificate
  ansible.builtin.uri:
    url: "{{ pfsense_api_url }}/services/acme/certificate{% if _cert_check.status == 200 %}/{{ _cert_check.json.data.id }}{% endif %}"
    method: "{{ 'PUT' if _cert_check.status == 200 else 'POST' }}"
    validate_certs: "{{ pfsense_validate_certs }}"
    headers:
      X-API-Key: "{{ pfsense_api_key }}"
      Content-Type: "application/json"
    body_format: json
    body:
      name: "{{ certificate.name }}"
      acmeaccount: "{{ pfsense_acme_account }}"
      domains: "{{ certificate.domains }}"
      renewafter: "{{ certificate.renewafter | default(60) }}"
    status_code: [200, 201]
  register: _cert_config

# Issue the certificate (triggers ACME challenge)
- name: Issue ACME certificate
  ansible.builtin.uri:
    url: "{{ pfsense_api_url }}/services/acme/certificate/issue"
    method: POST
    validate_certs: "{{ pfsense_validate_certs }}"
    headers:
      X-API-Key: "{{ pfsense_api_key }}"
      Content-Type: "application/json"
    body_format: json
    body:
      name: "{{ certificate.name }}"
    status_code: [200, 201]
  register: _cert_issue
  # Only issue if this is a new certificate or if explicitly requested
  when: _cert_check.status == 404

- name: Display certificate result
  ansible.builtin.debug:
    msg:
      - "ACME certificate: {{ 'ISSUED' if _cert_check.status == 404 else 'UPDATED' }}"
      - "Certificate: {{ certificate.name }}"
      - "Domains: {{ certificate.domains | map(attribute='domain') | list | join(', ') }}"
  when: ansible_verbosity >= 0
